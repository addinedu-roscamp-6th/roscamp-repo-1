<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>USER</title>
  <style>
    /* 기존 스타일 유지 */
    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }
    .main-container {
      width: 540px;
      margin: 40px auto;
      border: 1px solid #aaa;
      border-radius: 10px;
      padding: 24px;
      background: white;
      box-shadow: 0 6px 24px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .category-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      width: 100%;
    }
    .category-btn {
      width: 110px; height: 50px;
      line-height: 50px;
      border-radius: 6px;
      border: 2px solid #ececec;
      background: #fff;
      cursor: pointer;
    }
    .category-btn.active {
      background: #fde4c8;
      border-color: #edb887;
    }
    .select-box {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      margin-bottom: 18px;
      padding: 25px 18px 10px;
      border: 1.5px solid #bbb;
      background: #f7fafd;
      border-radius: 8px;
    }
    .rect-btn {
      width: 100px; height: 55px;
      font-size: 18px;
      border: 1.5px solid #666;
      border-radius: 7px;
      background: #fff;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .rect-btn.selected {
      background: #00aaff;
      border-color: #0088cc;
      color: white;
      font-weight: bold;
    }
    .bottom-row {
      display: flex;
      justify-content: space-between;
      width: 97%;
      margin-top: 12px;
      gap: 12px;
    }
    .wide-btn {
      flex: 1;
      height: 44px;
      font-size: 17px;
      padding-left: 18px;
    }
    .add-btn {
      width: 84px; height: 44px;
      font-size: 17px;
      border-radius: 7px;
      border: 1.5px solid #2299aa;
      background: #ffebee;
      font-weight: bold;
    }
    .selected-items-container {
      width: 540px;
      height: 120px;
      overflow-y: auto;
      border: 1px solid #2299aa;
      background: #edfaff;
      padding: 8px 12px;
      border-radius: 7px;
      font-weight: bold;
      margin-top: 12px;
    }
    .selected-items-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .selected-items-list li {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #b2dfee;
    }
    .delete-item-btn {
      background: #ffcccc;
      border: none;
      color: #a00;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      padding: 2px 6px;
    }
  </style>
</head>
<body>
<div class="main-container">
  <h2>{{ user.name }}님의 프로필</h2>
  <form id="requestForm" method="post" onsubmit="return confirmSubmit(event);">
    <input type="hidden" name="type" id="hidden_type" value="coffee">
    <input type="hidden" name="detail" id="hidden_detail" value="a">
    <input type="hidden" name="items" id="hidden_items" value="">
    <input type="hidden" name="location" id="hidden_location" value="">

    <div class="category-group" id="categoryGroup">
      <button type="button" class="category-btn active" data-type="coffee">음료</button>
      <button type="button" class="category-btn" data-type="snack">간식</button>
      <button type="button" class="category-btn" data-type="file">자료</button>
    </div>

    <div class="select-box" id="selectBox"></div>

    <div class="bottom-row">
      <button class="wide-btn" type="button" id="locationBtn">배송 위치 선택</button>
      <button class="add-btn" type="button" id="addBtn">추가</button>
    </div>

    <div class="selected-items-container" id="selectedItemsContainer">
      <ul class="selected-items-list" id="selectedItemsList">
        <li style="border-bottom:none; color:#777;">선택된 물품이 없습니다.</li>
      </ul>
    </div>

    <div class="submit-row" style="margin-top:13px; text-align:right;">
      <button class="submit-btn" type="submit">요청</button>
    </div>

    <p style="margin-top:8px;">{{ message }}</p>
  </form>

  <div id="deliveryStatus" style="margin-top:14px; font-weight:bold;"></div>
  {{ delivery_popup_script|safe }}
</div>

<div id="locationModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh;
            background:rgba(55,55,55,0.28); z-index:99; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:30px 24px; border-radius:12px;">
    <div style="font-size:22px; font-weight:bold; margin-bottom:8px;">배송 위치를 선택하세요</div>
    <div id="locationBtns" style="display:grid; grid-template-columns:repeat(3,1fr); gap:17px;"></div>
    <button id="modalCloseBtn" style="margin-top:14px;">닫기</button>
  </div>
</div>

<script>
  const robotLocation = "{{ robot_location|escapejs }}";
  const detailMap = {
    'coffee': ['a','b','c','d'],
    'snack': ['a','b','c','d'],
    'file': ['a','b','c','d'],
  };
  const typeLabel = { 'coffee':'음료', 'snack':'간식', 'file':'자료' };
  let selectedType = 'coffee';
  let selectedDetail = 'a';
  let selectedItems = [];
  const locations = ['A1','A2','B1','B2','C1','C2','기타'];
  let selectedLocation = '';

  // 카테고리별 영문 매칭
  const typeCodeMap = {
    'coffee': 'A',
    'snack': 'B',
    'file': 'C',
  };

  // detail (a,b,c,d) → 숫자 매핑
  const detailNumMap = {
    'a': '1',
    'b': '2',
    'c': '3',
    'd': '4',
  };

  function renderDetailButtons() {
    const box = document.getElementById('selectBox');
    box.innerHTML = '';
    for(const d of detailMap[selectedType]) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'rect-btn' + (selectedDetail === d ? ' selected' : '');
      btn.innerText = typeLabel[selectedType] + " " + d.toUpperCase();
      btn.onclick = () => {
        selectedDetail = d;
        document.getElementById('hidden_detail').value = d;
        renderDetailButtons();
      };
      box.appendChild(btn);
    }
  }

  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.onclick = function() {
      document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('active'));
      this.classList.add('active');
      selectedType = this.getAttribute('data-type');
      document.getElementById('hidden_type').value = selectedType;
      selectedDetail = detailMap[selectedType][0];
      document.getElementById('hidden_detail').value = selectedDetail;
      renderDetailButtons();
    };
  });

  // 선택된 아이템명을 리스트에 보여주고 서버전송용으로 변환하는 함수
  function updateSelectedItemsList() {
    const list = document.getElementById('selectedItemsList');
    list.innerHTML = '';
    if (selectedItems.length === 0) {
      list.innerHTML = '<li style="border-bottom:none; color:#777;">선택된 물품이 없습니다.</li>';
    } else {
      selectedItems.forEach((item, idx) => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.innerText = item;
        const delBtn = document.createElement('button');
        delBtn.innerText = '삭제';
        delBtn.className = 'delete-item-btn';
        delBtn.onclick = () => {
          selectedItems.splice(idx, 1);
          updateSelectedItemsList();
        };
        li.appendChild(span);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }
    // 여기서 서버로 전송할 코드(A1, B2, ...) 생성
    const codes = selectedItems.map(item => {
      // item은 "음료 A", "간식 B" 형태
      const parts = item.split(' ');  // ["음료", "A"]
      const typeKey = Object.keys(typeLabel).find(key => typeLabel[key] === parts[0]); // coffee, snack, file
      const letter = typeCodeMap[typeKey] || 'Z';  // A, B, C
      const detailLetter = parts[1].toLowerCase();  // a, b, c, d
      const number = detailNumMap[detailLetter] || '?';
      return letter + number;  // A1, B2 ...
    });
    document.getElementById('hidden_items').value = codes.join(',');
  }

  document.getElementById('addBtn').onclick = function() {
    const itemString = typeLabel[selectedType] + " " + selectedDetail.toUpperCase();
    selectedItems.push(itemString);
    updateSelectedItemsList();
  };

  document.getElementById('locationBtn').onclick = function() {
    const locBtns = document.getElementById('locationBtns');
    locBtns.innerHTML = '';
    locations.forEach(loc => {
      const b = document.createElement('button');
      b.innerText = loc;
      b.onclick = () => {
        selectedLocation = loc;
        document.getElementById('hidden_location').value = selectedLocation;
        document.getElementById('locationBtn').innerText = "배송 위치: " + selectedLocation;
        document.getElementById('locationModal').style.display = 'none';
      };
      locBtns.appendChild(b);
    });
    document.getElementById('locationModal').style.display = 'flex';
  };

  document.getElementById('modalCloseBtn').onclick = function() {
    document.getElementById('locationModal').style.display = 'none';
  };

  function confirmSubmit(event) {
    if (!confirm('요청하시겠습니까?')) {
      event.preventDefault();
      return false;
    }
    alert('등록되었습니다.');
    return true;
  }

  window.addEventListener('load', function() {
    renderDetailButtons();
    updateSelectedItemsList();
  });
</script>
</body>
</html>
